version: 2
stages:
  build:
    macos:
      xcode: "8.3.3"

    environment:
      ARTIFACTS: /artifacts

    working_directory: ~/ddev-ui

    steps:
      - checkout

      - run:
          name: VM setup
          command: |
            brew update  # added for https://discuss.circleci.com/t/homebrew-must-be-run-under-ruby-2-3-runtimeerror/17232/5
            brew cask install xquartz  # A dependency of wine
            brew install node wine

      - run:
          name: Installed tool versions
          command: echo "git commit=$(make version) node version=$(node --version) npm version=$(npm --version) wine version=$(wine --version) HOME=$HOME USER=$(whoami) PWD=$PWD"

      - run: make clean all

      - run:
          command: ./.circleci/generate_artifacts.sh $ARTIFACTS
          name: tar/zip up artifacts and make hashes

      - store_artifacts:
          path: /artifacts
          name: Artifact storage
