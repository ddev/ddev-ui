{"version":3,"file":"wine.js","sourceRoot":"","sources":["../src/wine.ts"],"names":[],"mappings":"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","sourcesContent":["import { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport * as semver from \"semver\"\nimport { getBinFromGithub } from \"./binDownload\"\nimport { computeEnv, EXEC_TIMEOUT, ToolInfo } from \"./bundledTool\"\nimport { getMacOsVersion } from \"./macosVersion\"\nimport { debug, exec, ExecOptions, isEnvTrue } from \"./util\"\n\nconst wineExecutable = new Lazy<ToolInfo>(async () => {\n  const isUseSystemWine = isEnvTrue(process.env.USE_SYSTEM_WINE)\n  if (isUseSystemWine) {\n    debug(\"Using system wine is forced\")\n  }\n  else if (process.platform === \"darwin\") {\n    const osVersion = await getMacOsVersion()\n    let version: string | null = null\n    let checksum: string | null = null\n    if (semver.gte(osVersion, \"10.13.0\")) {\n      version = \"2.0.2-mac-10.13\"\n      // noinspection SpellCheckingInspection\n      checksum = \"v6r9RSQBAbfvpVQNrEj48X8Cw1181rEGMRatGxSKY5p+7khzzy/0tOdfHGO8cU+GqYvH43FAKMK8p6vUfCqSSA==\"\n    }\n    else if (semver.gte(osVersion, \"10.12.0\")) {\n      version = \"2.0.1-mac-10.12\"\n      // noinspection SpellCheckingInspection\n      checksum = \"IvKwDml/Ob0vKfYVxcu92wxUzHu8lTQSjjb8OlCTQ6bdNpVkqw17OM14TPpzGMIgSxfVIrQZhZdCwpkxLyG3mg==\"\n    }\n\n    if (version != null) {\n      const wineDir = await getBinFromGithub(\"wine\", version, checksum!!)\n      return {\n        path: path.join(wineDir, \"bin/wine\"),\n        env: {\n          ...process.env,\n          WINEDEBUG: \"-all,err+all\",\n          WINEDLLOVERRIDES: \"winemenubuilder.exe=d\",\n          WINEPREFIX: path.join(wineDir, \"wine-home\"),\n          DYLD_FALLBACK_LIBRARY_PATH: computeEnv(process.env.DYLD_FALLBACK_LIBRARY_PATH, [path.join(wineDir, \"lib\")])\n        }\n      }\n    }\n  }\n\n  await checkWineVersion(exec(\"wine\", [\"--version\"]))\n  return {path: \"wine\"}\n})\n\n/** @private */\nexport function execWine(file: string, args: Array<string>, options: ExecOptions = EXEC_TIMEOUT): Promise<string> {\n  if (process.platform === \"win32\") {\n    return exec(file, args, options)\n  }\n  else {\n    return wineExecutable.value\n      .then(wine => exec(wine.path, [file].concat(args), wine.env == null ? options : {env: wine.env, ...options}))\n  }\n}\n\n/** @private */\nexport function prepareWindowsExecutableArgs(args: Array<string>, exePath: string) {\n  if (process.platform !== \"win32\") {\n    args.unshift(exePath)\n  }\n  return args\n}\n\n/** @private */\nexport async function checkWineVersion(checkPromise: Promise<string>) {\n  function wineError(prefix: string): string {\n    return `${prefix}, please see https://electron.build/multi-platform-build#${(process.platform === \"linux\" ? \"linux\" : \"macos\")}`\n  }\n\n  let wineVersion: string\n  try {\n    wineVersion = (await checkPromise).trim()\n  }\n  catch (e) {\n    if (e.code === \"ENOENT\") {\n      throw new Error(wineError(\"wine is required\"))\n    }\n    else {\n      throw new Error(`Cannot check wine version: ${e}`)\n    }\n  }\n\n  if (wineVersion.startsWith(\"wine-\")) {\n    wineVersion = wineVersion.substring(\"wine-\".length)\n  }\n\n  const spaceIndex = wineVersion.indexOf(\" \")\n  if (spaceIndex > 0) {\n    wineVersion = wineVersion.substring(0, spaceIndex)\n  }\n\n  const suffixIndex = wineVersion.indexOf(\"-\")\n  if (suffixIndex > 0) {\n    wineVersion = wineVersion.substring(0, suffixIndex)\n  }\n\n  if (wineVersion.split(\".\").length === 2) {\n    wineVersion += \".0\"\n  }\n\n  if (semver.lt(wineVersion, \"1.8.0\")) {\n    throw new Error(wineError(`wine 1.8+ is required, but your version is ${wineVersion}`))\n  }\n}"]}
