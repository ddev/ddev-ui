{"version":3,"file":"windowsCodeSign.js","sourceRoot":"","sources":["../src/windowsCodeSign.ts"],"names":[],"mappings":"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","sourcesContent":["import { exec, isMacOsSierra, warn } from \"builder-util\"\nimport { getBinFromGithub } from \"builder-util/out/binDownload\"\nimport { computeToolEnv, ToolInfo } from \"builder-util/out/bundledTool\"\nimport { rename } from \"fs-extra-p\"\nimport isCi from \"is-ci\"\nimport * as os from \"os\"\nimport * as path from \"path\"\nimport { WindowsConfiguration } from \"./options/winOptions\"\nimport { resolveFunction } from \"./platformPackager\"\nimport { isUseSystemSigncode } from \"./util/flags\"\n\nexport function getSignVendorPath() {\n  //noinspection SpellCheckingInspection\n  return getBinFromGithub(\"winCodeSign\", \"1.9.0\", \"cyhO9Mv5MTP2o9dwk/+qs0KvuO9CbDhjEJXA2ujpvhcsk5zmc+zY9iqiWXVzOuibTLYNC3qZiuFlJrrCT2kldw==\")\n}\n\nexport interface FileCodeSigningInfo {\n  readonly file?: string | null\n  readonly password?: string | null\n\n  readonly subjectName?: string | null\n  readonly certificateSha1?: string | null\n}\n\nexport type CustomWindowsSign = (configuration: CustomWindowsSignTaskConfiguration) => Promise<any>\n\nexport interface WindowsSignOptions {\n  readonly path: string\n\n  readonly cert?: string | null\n\n  readonly name?: string | null\n  readonly password?: string | null\n  readonly site?: string | null\n\n  readonly options: WindowsConfiguration\n}\n\nexport interface WindowsSignTaskConfiguration extends WindowsSignOptions {\n  // set if output path differs from input (e.g. osslsigncode cannot sign file inplace)\n  resultOutputPath?: string\n\n  hash: string\n  isNest: boolean\n}\n\nexport interface CustomWindowsSignTaskConfiguration extends WindowsSignTaskConfiguration {\n  computeSignToolArgs(isWin: boolean): Array<string>\n}\n\nexport async function sign(options: WindowsSignOptions) {\n  let hashes = options.options.signingHashAlgorithms\n  // msi does not support dual-signing\n  if (options.path.endsWith(\".msi\")) {\n    hashes = [hashes != null && !hashes.includes(\"sha1\") ? \"sha256\" : \"sha1\"]\n  }\n  else if (options.path.endsWith(\".appx\")) {\n    hashes = [\"sha256\"]\n  }\n  else if (hashes == null) {\n    hashes = [\"sha1\", \"sha256\"]\n  }\n  else {\n    hashes = Array.isArray(hashes) ? hashes : [hashes]\n  }\n\n  const executor = resolveFunction(options.options.sign) || doSign\n  let isNest = false\n  for (const hash of hashes) {\n    const taskConfiguration: WindowsSignTaskConfiguration = {...options, hash, isNest}\n    await executor({\n      ...taskConfiguration,\n      computeSignToolArgs: isWin => computeSignToolArgs(taskConfiguration, isWin)\n    })\n    isNest = true\n    if (taskConfiguration.resultOutputPath != null) {\n      await rename(taskConfiguration.resultOutputPath, options.path)\n    }\n  }\n}\n\nasync function doSign(configuration: CustomWindowsSignTaskConfiguration) {\n  const toolInfo = await getToolPath()\n  await exec(toolInfo.path, configuration.computeSignToolArgs(process.platform === \"win32\"), {\n    // https://github.com/electron-userland/electron-builder/pull/1944\n    timeout: parseInt(process.env.SIGNTOOL_TIMEOUT as any, 10) || 10 * 60 * 1000,\n    env: toolInfo.env || process.env\n  })\n}\n\n// on windows be aware of http://stackoverflow.com/a/32640183/1910191\nfunction computeSignToolArgs(options: WindowsSignTaskConfiguration, isWin: boolean): Array<string> {\n  const outputPath = isWin ? options.path : getOutputPath(options.path, options.hash)\n  if (!isWin) {\n    options.resultOutputPath = outputPath\n  }\n\n  const args = isWin ? [\"sign\"] : [\"-in\", options.path, \"-out\", outputPath]\n\n  if (process.env.ELECTRON_BUILDER_OFFLINE !== \"true\") {\n    const timestampingServiceUrl = options.options.timeStampServer || \"http://timestamp.verisign.com/scripts/timstamp.dll\"\n    if (isWin) {\n      args.push(options.isNest || options.hash === \"sha256\" ? \"/tr\" : \"/t\", options.isNest || options.hash === \"sha256\" ? (options.options.rfc3161TimeStampServer || \"http://timestamp.comodoca.com/rfc3161\") : timestampingServiceUrl)\n    }\n    else {\n      args.push(\"-t\", timestampingServiceUrl)\n    }\n  }\n\n  const certificateFile = options.cert\n  if (certificateFile == null) {\n    const subjectName = options.options.certificateSubjectName\n    if (process.platform !== \"win32\") {\n      throw new Error(`${subjectName == null ? \"certificateSha1\" : \"certificateSubjectName\"} supported only on Windows`)\n    }\n\n    if (subjectName == null) {\n      args.push(\"/sha1\", options.options.certificateSha1!)\n    }\n    else {\n      args.push(\"/n\", subjectName)\n    }\n  }\n  else {\n    const certExtension = path.extname(certificateFile)\n    if (certExtension === \".p12\" || certExtension === \".pfx\") {\n      args.push(isWin ? \"/f\" : \"-pkcs12\", certificateFile)\n    }\n    else {\n      throw new Error(`Please specify pkcs12 (.p12/.pfx) file, ${certificateFile} is not correct`)\n    }\n  }\n\n  if (!isWin || options.hash !== \"sha1\") {\n    args.push(isWin ? \"/fd\" : \"-h\", options.hash)\n    if (isWin && process.env.ELECTRON_BUILDER_OFFLINE !== \"true\") {\n      args.push(\"/td\", \"sha256\")\n    }\n  }\n\n  if (options.name) {\n    args.push(isWin ? \"/d\" : \"-n\", options.name)\n  }\n\n  if (options.site) {\n    args.push(isWin ? \"/du\" : \"-i\", options.site)\n  }\n\n  // msi does not support dual-signing\n  if (options.isNest) {\n    args.push(isWin ? \"/as\" : \"-nest\")\n  }\n\n  if (options.password) {\n    args.push(isWin ? \"/p\" : \"-pass\", options.password)\n  }\n\n  if (options.options.additionalCertificateFile) {\n    args.push(isWin ? \"/ac\" : \"-ac\", options.options.additionalCertificateFile)\n  }\n\n  if (isWin) {\n    // must be last argument\n    args.push(options.path)\n  }\n\n  return args\n}\n\nfunction getOutputPath(inputPath: string, hash: string) {\n  const extension = path.extname(inputPath)\n  return path.join(path.dirname(inputPath), `${path.basename(inputPath, extension)}-signed-${hash}${extension}`)\n}\n\n/** @internal */\nexport function isOldWin6() {\n  const winVersion = os.release()\n  return winVersion.startsWith(\"6.\") && !winVersion.startsWith(\"6.3\")\n}\n\nasync function getToolPath(): Promise<ToolInfo> {\n  if (isUseSystemSigncode()) {\n    return {path: \"osslsigncode\"}\n  }\n\n  const result = process.env.SIGNTOOL_PATH\n  if (result) {\n    return {path: result}\n  }\n\n  const vendorPath = await getSignVendorPath()\n  if (process.platform === \"win32\") {\n    // use modern signtool on Windows Server 2012 R2 to be able to sign AppX\n    if (isOldWin6()) {\n      return {path: path.join(vendorPath, \"windows-6\", \"signtool.exe\")}\n    }\n    else {\n      return {path: path.join(vendorPath, \"windows-10\", process.arch, \"signtool.exe\")}\n    }\n  }\n  else if (process.platform === \"darwin\") {\n    let suffix: string | null = null\n    try {\n      if (await isMacOsSierra()) {\n        const toolDirPath = path.join(vendorPath, process.platform, \"10.12\")\n        return {\n          path: path.join(toolDirPath, \"osslsigncode\"),\n          env: computeToolEnv([path.join(toolDirPath, \"lib\")]),\n        }\n      }\n      else if (isCi) {\n        // not clear for what we do this instead of using version detection\n        suffix = \"ci\"\n      }\n    }\n    catch (e) {\n      warn(`${e.stack || e}`)\n    }\n    return {path: path.join(vendorPath, process.platform, `${suffix == null ? \"\" : `${suffix}/`}osslsigncode`)}\n  }\n  else {\n    return {path: path.join(vendorPath, process.platform, \"osslsigncode\")}\n  }\n}\n"]}
