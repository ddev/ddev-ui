{"version":3,"file":"nsisUtil.js","sourceRoot":"","sources":["../../../src/targets/nsis/nsisUtil.ts"],"names":[],"mappings":"AAAA,AAAO,AAAe,AAAM,AAAc;;;;;;;;;;;;;;;;;;;;;;;AAG1C,AAAO,AAAE,AAAM,AAAE,AAAM,AAAY;;;;;;AACnC,AAAO,AAAE,AAAe,AAAE,AAAM,AAAwB,AAGxD,AAAM;;;;;;AAAC,MAAM,AAAgB,8CAAG,AAAe,2DAAC,AAAM,AAAC,AAEvD,AAAM;;AAAN;AACmB,aAAc,iBAAG,IAAI,AAAG,AAAkC;AAC1D,aAAc,iBAAG,IAAI,AAAG,AAA4B;AAErE,AAAe;AACf,aAAQ,WAAG,AAAC,AAiCd;AAAC;AA/BO,AAAQ,YAAd,AAAK,CAAU,AAAU,MAAE,AAAkB;;;;AAC3C,gBAAI,AAAW,cAAG,AAAI,MAAC,AAAc,eAAC,AAAG,IAAC,AAAI,AAAC;AAC/C,AAAE,AAAC,gBAAC,AAAW,eAAI,AAAI,AAAC,MAAC,AAAC;AACxB,AAAW,8BAAG,AAAM,OAAC,AAAe,gBAAC,AAAM,OAAC,AAAK,MAAC,AAAG,IAAC,AAAI,AAAE,OAAE,AAAI,AAAC;AACnE,AAAI,sBAAC,AAAc,eAAC,AAAG,IAAC,AAAI,MAAE,AAAW,AAAC,AAC5C;AAAC;AAED,kBAAM,AAAI,OAAG,MAAM,AAAW;AAC9B,AAAE,AAAC,gBAAC,AAAM,OAAC,AAAc,AAAC,gBAAC,AAAC;AAC1B,AAAI,sBAAC,AAAc,eAAC,AAAG,IAAC,AAAI,MAAE,AAAK,AAAC,AACtC;AAAC,AACD,AAAI,mBAAC,AAAE,AAAC,IAAC,CAAC,AAAI,MAAC,AAAc,eAAC,AAAG,IAAC,AAAI,AAAC,AAAC,OAAC,AAAC;AACxC,AAAI,sBAAC,AAAc,eAAC,AAAG,IAAC,AAAI,MAAE,AAAI,AAAC,AACrC;AAAC;AACD,AAAM,mBAAC,AAAI,AACb;;AAAC;AAEK,AAAW,eAAjB,AAAK;;;;AACH,AAAE,AAAC,gBAAC,EAAE,AAAI,OAAC,AAAQ,WAAG,AAAC,AAAC,GAAC,AAAC;AACxB,AAAM,AACR;AAAC;AAED,kBAAM,AAAa,gBAAkB,AAAE;AACvC,AAAG,AAAC,AAAC,AAAM,+BAAqB,AAAI,OAAC,AAAc,eAAC,AAAO,AAAE,AAAC;AAAC,AAAC;;sBAApD,AAAI;sBAAE,AAAQ,AAAC;;AACzB,AAAE,AAAC,oBAAC,AAAQ,AAAC,UAAC,AAAC;AACb,AAAa,kCAAC,AAAI,KAAC,AAAI,KAAC,AAAI,AAAC,AAC/B;AAAC,AACH;AAAC;AAED,kEAAsB,AAAG,IAAC,AAAa;AAAE,AAAE,uBAAI,AAAM,4CAAC,AAAE,AAAC,AAAC,AAC5D;aADQ,AAAe;;AACtB,AACF","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch } from \"builder-util\"\nimport { PackageFileInfo } from \"builder-util-runtime\"\nimport { unlink } from \"fs-extra-p\"\nimport { getTemplatePath } from \"../../util/pathManager\"\nimport { NsisTarget } from \"./nsis\"\n\nexport const nsisTemplatesDir = getTemplatePath(\"nsis\")\n\nexport class AppPackageHelper {\n  private readonly archToFileInfo = new Map<Arch, Promise<PackageFileInfo>>()\n  private readonly infoToIsDelete = new Map<PackageFileInfo, boolean>()\n\n  /** @private */\n  refCount = 0\n\n  async packArch(arch: Arch, target: NsisTarget): Promise<PackageFileInfo> {\n    let infoPromise = this.archToFileInfo.get(arch)\n    if (infoPromise == null) {\n      infoPromise = target.buildAppPackage(target.archs.get(arch)!, arch)\n      this.archToFileInfo.set(arch, infoPromise)\n    }\n\n    const info = await infoPromise\n    if (target.isWebInstaller) {\n      this.infoToIsDelete.set(info, false)\n    }\n    else if (!this.infoToIsDelete.has(info)) {\n      this.infoToIsDelete.set(info, true)\n    }\n    return info\n  }\n\n  async finishBuild(): Promise<any> {\n    if (--this.refCount > 0) {\n      return\n    }\n\n    const filesToDelete: Array<string> = []\n    for (const [info, isDelete]  of this.infoToIsDelete.entries()) {\n      if (isDelete) {\n        filesToDelete.push(info.file)\n      }\n    }\n\n    await BluebirdPromise.map(filesToDelete, it => unlink(it))\n  }\n}"]}
