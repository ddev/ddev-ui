{"version":3,"file":"appFileCopier.js","sourceRoot":"","sources":["../../src/util/appFileCopier.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { AsyncTaskManager } from \"builder-util\"\nimport { CONCURRENCY, FileCopier, Link, MAX_FILE_REQUESTS } from \"builder-util/out/fs\"\nimport { ensureDir, readlink, symlink } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Packager } from \"../packager\"\nimport { ensureEndSlash, ResolvedFileSet } from \"./AppFileCopierHelper\"\nimport { copyFileOrData } from \"./asarUtil\"\n\nexport function getDestinationPath(file: string, fileSet: ResolvedFileSet) {\n  return file === fileSet.src ? fileSet.destination : file.replace(ensureEndSlash(fileSet.src), ensureEndSlash(fileSet.destination))\n}\n\nexport async function copyAppFiles(fileSet: ResolvedFileSet, packager: Packager) {\n  const metadata = fileSet.metadata\n  const transformedFiles = fileSet.transformedFiles\n  // search auto unpacked dir\n  const taskManager = new AsyncTaskManager(packager.cancellationToken)\n  const createdParentDirs = new Set<string>()\n\n  const fileCopier = new FileCopier()\n  const links: Array<Link> = []\n  for (let i = 0, n = fileSet.files.length; i < n; i++) {\n    const sourceFile = fileSet.files[i]\n    const stat = metadata.get(sourceFile)\n    if (stat == null) {\n      // dir\n      continue\n    }\n\n    const destinationFile = getDestinationPath(sourceFile, fileSet)\n    if (stat.isFile()) {\n      const newData = transformedFiles == null ? null : transformedFiles[i] as string | Buffer\n      if (newData != null) {\n        transformedFiles[i] = null\n      }\n\n      const fileParent = path.dirname(destinationFile)\n      if (!createdParentDirs.has(fileParent)) {\n        createdParentDirs.add(fileParent)\n        await ensureDir(fileParent)\n      }\n\n      taskManager.addTask(copyFileOrData(fileCopier, newData, sourceFile, destinationFile, stat))\n      if (taskManager.tasks.length > MAX_FILE_REQUESTS) {\n        await taskManager.awaitTasks()\n      }\n    }\n    else if (stat.isSymbolicLink()) {\n      links.push({file: destinationFile, link: await readlink(sourceFile)})\n    }\n  }\n\n  if (taskManager.tasks.length > MAX_FILE_REQUESTS) {\n    await taskManager.awaitTasks()\n  }\n  if (links.length > 0) {\n    BluebirdPromise.map(links, it => symlink(it.link, it.file), CONCURRENCY)\n  }\n}"]}
